<%= javascript_include_tag 'records' %>
<script>
	function clean(){
		$('#vs').css('display','none');
		$('#year2').css('display','none');
		$('#player2').css('display','none');
	}
	
	function onSingleClick(){
		clean();
		num = 1;
		i = document.getElementById('player'+num).length;
		document.getElementById('player'+num).options[i] = new Option("all", "all");
		document.getElementById('player'+num).length = i + 1;
		document.getElementById('player'+num).selectedIndex = i;
	}
	function onPKClick()
	{
		$('#vs').css('display','block');
		$('#year2').css('display','block');
		$('#player2').css('display','block');
		select_year(1);
		select_year(2);
	}
	function select_year(num){
		year = ((num==1)?(document.getElementById('year1').value):(document.getElementById('year2').value));
		obj = eval('playerIn'+year);
		for(i=0;i<obj.length;i++) document.getElementById('player'+num).options[i] = new Option(obj[i], obj[i]);
		document.getElementById('player'+num).length = i;
		
		if($("input[name=type]:checked").val() == "pk") // pk
		{
			document.getElementById('player'+num).selectedIndex = 0;
		}
		else
		{
			document.getElementById('player'+num).selectedIndex = i -1;
			i = document.getElementById('player'+num).length;
			document.getElementById('player'+num).options[i] = new Option("all", "all");
			document.getElementById('player'+num).length = i + 1;
			document.getElementById('player'+num).selectedIndex = i;
		}
	}
		
	$(window).on('load', function(){
		clean();
		select_year(1);
	});
		
	
</script>
<!-- Main -->
<section id="record_index">
<div class="container-fluid">
    <div class="row">
        <%= render :partial => "sidebar" %>
		<div class="col-sm-9">
			<h3>打擊查詢</h3>
			<hr>
			<% if @player == nil %>
				<script>
					<% @year_option.each do |yearOption| %>
						var <%= 'playerIn' + yearOption[1].to_s %> = new Array();
						<% @playerInThisYear = playersInYear(yearOption[1]) %>
						<% @playerInThisYear.each do |playerITY| %>
							<%= 'playerIn' + yearOption[1].to_s %>.push("<%= playerITY.player_id %>");
						<% end %>
					<% end %>
				</script>
				<%= form_tag("batting" , method:"get") do %>
					<table>
						<tr>
							<td colspan="5">
								<%= radio_button_tag 'type', 'single', true, onclick:"onSingleClick();" %>Single Player
								<%= radio_button_tag 'type', 'pk', false, onclick:"onPKClick();" %>Two Players
							</td>
						</tr>
						<tr>
							<td><%= select_tag(:year1, options_for_select(@year_option,@year_option[@year_option.length-2][1]), onchange:"select_year(1);") %></td>
							<td><%= select_tag(:player1) %></td>
							<td><span id="vs"> vs. </span></td>
							<td><%= select_tag(:year2, options_for_select(@year_option,@year_option[@year_option.length-2][1]), onchange:"select_year(2);") %></td>
							<td><%= select_tag(:player2) %></td>
						</tr>
						<tr>
							<td colspan="5"><%= submit_tag("查詢", name: nil) %></td>
						</tr>
					</table>
				<% end %>
			<% elsif @player == "all" %>
				<h4><%= @year == "Wildcard"? ("不分"):(@year) %>年度 打擊成績</h4>
				<br/>
				<h5 style="margin:0 0 10px; text-transform:none">Active Player: 認定標準為每場<%= @activePLAYER_rate %>打席 -- 目前 <%= @gameNumberInYear[@year.to_s] %> 場；或打席達<%= @activePLAYER %>以上者。</h5>
				<h5 style="margin:0 0 10px; text-transform:none" id="description"></h5>
				<h5 style="margin:0 0 10px; text-transform:none"><點選各項目表頭以進行排序></h5>
				<div class="table-responsive" id="div_game_oneyear">
					<table class="table table-striped table-condensed" id="table_game_oneyear" data-toggle="table" data-sort-name="AVG" data-sort-order="desc">
						<thead>
							<tr>
								<th data-field="Name" data-sortable="true" data-sorter="NameSorter">Name<br/>姓名</th>
								<th data-field="G" data-sortable="true" data-sorter="normalSorter">G<br/>場次</th>
								<th data-field="PA" data-sortable="true" data-sorter="normalSorter">PA<br/>打席</th>
								<th data-field="AB" data-sortable="true" data-sorter="normalSorter">AB<br/>打數</th>
								<th data-field="H" data-sortable="true" data-sorter="normalSorter">H<br/>安打</th>
								<th data-field="B2" data-sortable="true" data-sorter="normalSorter">2B<br/>二壘</th>
								<th data-field="B3" data-sortable="true" data-sorter="normalSorter">3B<br/>三壘</th>
								<th data-field="HR" data-sortable="true" data-sorter="normalSorter">HR<br/>全壘</th>
								<th data-field="TB" data-sortable="true" data-sorter="normalSorter">TB<br/>壘打數</th>
								<th data-field="RBI" data-sortable="true" data-sorter="normalSorter">RBI<br/>打點</th>
								<th data-field="R" data-sortable="true" data-sorter="normalSorter">R<br/>得分</th>
								<th data-field="SO" data-sortable="true" data-sorter="normalSorter">SO<br/>三振</th>
								<th data-field="BB" data-sortable="true" data-sorter="normalSorter">BB<br/>四壞</th>
								<th data-field="IBB" data-sortable="true" data-sorter="normalSorter">IBB<br/>故意</th>
								<th data-field="SF" data-sortable="true" data-sorter="normalSorter">SF<br/>犧牲</th>
								<th data-field="E" data-sortable="true" data-sorter="normalSorter">BOE<br/>失誤</th>
								<th data-field="AVG" data-sortable="true" data-sort-name="_AVG_data" data-sorter="AVGSorter">AVG<br/>打擊率</th>
								<th data-field="OBP" data-sortable="true" data-sort-name="_OBP_data" data-sorter="OBPSorter">OBP<br/>上壘率</th>
								<th data-field="SLG" data-sortable="true" data-sort-name="_SLG_data" data-sorter="SLGSorter">SLG<br/>長打率</th>
								<th data-field="OPS" data-sortable="true" data-sort-name="_OPS_data" data-sorter="OPSSorter">OPS<br/>整體攻擊指數</th>
								<th data-field="TA" data-sortable="true" data-sort-name="_TA_data" data-sorter="TASorter">TA<br/>攻擊指數</th>
							</tr>
						</thead>
						<script>
							function clearDescription(){
								$('#description').text('');
							}
							function NameSorter(a, b) {
								clearDescription();
								if (a.toLowerCase() > b.toLowerCase()) return 1;
								if (a.toLowerCase() < b.toLowerCase()) return -1;
								return 0;
							}
							function normalSorter(a, b) {
								clearDescription();
								if (parseInt(a) > parseInt(b)) return 1;
								if (parseInt(a) < parseInt(b)) return -1;
								return 0;
							}
							function AVGSorter(a, b) {
								$('#description').text('打擊率 = 安打數 / 打數');
								// 兩階段sorting - 先過濾打席是否足額
								if(a.pa >= <%= (@gameNumberInYear[@year.to_s] * @activePLAYER_rate) %> && b.pa < <%= (@gameNumberInYear[@year.to_s] * @activePLAYER_rate) %>)
									return 1;
								else if(a.pa < <%= (@gameNumberInYear[@year.to_s] * @activePLAYER_rate) %> && b.pa >= <%= (@gameNumberInYear[@year.to_s] * @activePLAYER_rate) %>)
									return -1;
								// 再相比實際數值
								else{
									if(a.avg > b.avg) return 1;
									if(a.avg < b.avg) return -1;
									return 0;
								}
							}
							function OBPSorter(a, b) {
								$('#description').text('上壘率 = 安打數 + 四死球 / 打席');
								// 兩階段sorting - 先過濾打席是否足額
								if(a.pa >= <%= (@gameNumberInYear[@year.to_s] * @activePLAYER_rate) %> && b.pa < <%= (@gameNumberInYear[@year.to_s] * @activePLAYER_rate) %>)
									return 1;
								else if(a.pa < <%= (@gameNumberInYear[@year.to_s] * @activePLAYER_rate) %> && b.pa >= <%= (@gameNumberInYear[@year.to_s] * @activePLAYER_rate) %>)
									return -1;
								// 再相比實際數值
								else{
									if(a.obp > b.obp) return 1;
									if(a.obp < b.obp) return -1;
									return 0;
								}
							}
							function SLGSorter(a, b) {
								$('#description').text('長打率 = 壘打數 / 打數');
								// 兩階段sorting - 先過濾打席是否足額
								if(a.pa >= <%= (@gameNumberInYear[@year.to_s] * @activePLAYER_rate) %> && b.pa < <%= (@gameNumberInYear[@year.to_s] * @activePLAYER_rate) %>)
									return 1;
								else if(a.pa < <%= (@gameNumberInYear[@year.to_s] * @activePLAYER_rate) %> && b.pa >= <%= (@gameNumberInYear[@year.to_s] * @activePLAYER_rate) %>)
									return -1;
								// 再相比實際數值
								else{
									if(a.slg > b.slg) return 1;
									if(a.slg < b.slg) return -1;
									return 0;
								}
							}
							function OPSSorter(a, b) {
								$('#description').text('整體攻擊指數 = 上壘率 + 長打率');
								// 兩階段sorting - 先過濾打席是否足額
								if(a.pa >= <%= (@gameNumberInYear[@year.to_s] * @activePLAYER_rate) %> && b.pa < <%= (@gameNumberInYear[@year.to_s] * @activePLAYER_rate) %>)
									return 1;
								else if(a.pa < <%= (@gameNumberInYear[@year.to_s] * @activePLAYER_rate) %> && b.pa >= <%= (@gameNumberInYear[@year.to_s] * @activePLAYER_rate) %>)
									return -1;
								// 再相比實際數值
								else{
									if(a.ops > b.ops) return 1;
									if(a.ops < b.ops) return -1;
									return 0;
								}
							}
							function TASorter(a, b) {
								$('#description').text('攻擊指數 = (壘打數 + 盜壘成功數 + 四死球) / (打數 - 安打數 + 雙殺打)');
								// 兩階段sorting - 先過濾打席是否足額
								if(a.pa >= <%= (@gameNumberInYear[@year.to_s] * @activePLAYER_rate) %> && b.pa < <%= (@gameNumberInYear[@year.to_s] * @activePLAYER_rate) %>)
									return 1;
								else if(a.pa < <%= (@gameNumberInYear[@year.to_s] * @activePLAYER_rate) %> && b.pa >= <%= (@gameNumberInYear[@year.to_s] * @activePLAYER_rate) %>)
									return -1;
								// 再相比實際數值
								else{
									if(a.ta > b.ta) return 1;
									if(a.ta < b.ta) return -1;
									return 0;
								}
							}
						</script>
						<% if @allActiveBatting.size != 0 %>
							<tbody>
								<% @allActiveBatting.each do |allActiveBat| %>
									<tr>
										<td>
											<%= link_to allActiveBat.player_id, controller: "records", action: "batting", player: allActiveBat.player_id, year: @year %>
										</td>
										<td><%= allActiveBat.G %></td>
										<td><%= allActiveBat.PA %></td>
										<td><%= allActiveBat.AB %></td>
										<td><%= allActiveBat.H %></td>
										<td><%= allActiveBat.B2 %></td>
										<td><%= allActiveBat.B3 %></td>
										<td><%= allActiveBat.HR %></td>
										<td><%= allActiveBat.TB %></td>
										<td><%= allActiveBat.RBI %></td>
										<td><%= allActiveBat.R %></td>
										<td><%= allActiveBat.SO %></td>
										<td><%= allActiveBat.BB %></td>
										<td><%= allActiveBat.IBB %></td>
										<td><%= allActiveBat.SF %></td>
										<td><%= allActiveBat.E %></td>
										<td data-PA="<%= allActiveBat.PA %>" data-AVG="<%= '%.3f' % allActiveBat.AVG %>"><%= '%.3f' % allActiveBat.AVG %></td>
										<td data-PA="<%= allActiveBat.PA %>" data-OBP="<%= '%.3f' % allActiveBat.OBP %>"><%= '%.3f' % allActiveBat.OBP %></td>
										<td data-PA="<%= allActiveBat.PA %>" data-SLG="<%= '%.3f' % allActiveBat.SLG %>"><%= '%.3f' % allActiveBat.SLG %></td>
										<td data-PA="<%= allActiveBat.PA %>" data-OPS="<%= '%.3f' % allActiveBat.OPS %>"><%= '%.3f' % allActiveBat.OPS %></td>
										<td data-PA="<%= allActiveBat.PA %>" data-TA="<%= '%.3f' % allActiveBat.TA %>"><%= '%.3f' % allActiveBat.TA %></td>
									</tr>
								<% end %>
							</tbody>
						<% end %>
						<tfoot>
							<tr>
								<td><td>
							</tr>
						</tfoot>
					</table>
					
				</div>
			<% end %>
        </div>
        <!--/col-span-9-->
    </div>
</div>
<!-- /Main -->
</section>