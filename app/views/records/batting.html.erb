<%= javascript_include_tag 'records' %>
<!-- Main -->
<section id="records">
<div class="container-fluid">
    <div class="row">
        <%= render :partial => "sidebar" %>
		<div class="col-sm-9">
			<h3>打擊查詢</h3>
			<hr>
			<% if @player == nil %>
				<script>
					function clean(){
						$('#vs').css('display','none');
						$('#year2').css('display','none');
						$('#player2').css('display','none');
					}
					
					function onSingleClick(){
						clean();
						num = 1;
						i = document.getElementById('player'+num).length;
						document.getElementById('player'+num).options[i] = new Option("all", "all");
						document.getElementById('player'+num).length = i + 1;
						document.getElementById('player'+num).selectedIndex = i;
					}
					function onPKClick()
					{
						$('#vs').css('display','block');
						$('#year2').css('display','block');
						$('#player2').css('display','block');
						select_year(1);
						select_year(2);
					}
					function select_year(num){
						year = ((num==1)?(document.getElementById('year1').value):(document.getElementById('year2').value));
						obj = eval('playerIn'+year);
						for(i=0;i<obj.length;i++) document.getElementById('player'+num).options[i] = new Option(obj[i], obj[i]);
						document.getElementById('player'+num).length = i;
						
						if($("input[name=type]:checked").val() == "pk") // pk
						{
							document.getElementById('player'+num).selectedIndex = 0;
						}
						else
						{
							document.getElementById('player'+num).selectedIndex = i -1;
							i = document.getElementById('player'+num).length;
							document.getElementById('player'+num).options[i] = new Option("all", "all");
							document.getElementById('player'+num).length = i + 1;
							document.getElementById('player'+num).selectedIndex = i;
						}
					}
						
					$(window).on('load', function(){
						clean();
						select_year(1);
					});
				
					<% @year_option.each do |yearOption| %>
						var <%= 'playerIn' + yearOption[1].to_s %> = new Array();
						<% @playerInThisYear = playersInYear(yearOption[1]) %>
						<% @playerInThisYear.each do |playerITY| %>
							<%= 'playerIn' + yearOption[1].to_s %>.push("<%= playerITY.player_id %>");
						<% end %>
					<% end %>
				</script>
				<%= form_tag("batting" , method:"get") do %>
					<table>
						<tr>
							<td colspan="5">
								<%= radio_button_tag 'type', 'single', true, onclick:"onSingleClick();" %>Single Player
								<%= radio_button_tag 'type', 'pk', false, onclick:"onPKClick();" %>Two Players
							</td>
						</tr>
						<tr>
							<td><%= select_tag(:year1, options_for_select(@year_option,@year_option[@year_option.length-2][1]), onchange:"select_year(1);") %></td>
							<td><%= select_tag(:player1) %></td>
							<td><span id="vs"> vs. </span></td>
							<td><%= select_tag(:year2, options_for_select(@year_option,@year_option[@year_option.length-2][1]), onchange:"select_year(2);") %></td>
							<td><%= select_tag(:player2) %></td>
						</tr>
						<tr>
							<td colspan="5"><%= submit_tag("查詢", name: nil) %></td>
						</tr>
					</table>
				<% end %>
			<% elsif @player == "all" %>
				<h4><%= @year == "Wildcard"? ("不分"):(@year) %>年度打擊成績</h4>
				<br/>
				<h5 style="margin:0 0 10px; text-transform:none">Active Player: 認定標準為每場<%= @activePLAYER_rate %>打席 -- 目前 <%= @gameNumberInYear[@year.to_s] %> 場；或打席達<%= @activePLAYER %>以上者。</h5>
				<h5 style="margin:0 0 10px; text-transform:none" id="description"></h5>
				<h5 style="margin:0 0 10px; text-transform:none"><點選各項目表頭以進行排序></h5>
				<div id="wrapperForScrollbar">
					<div id="fakeContentForScrollBar"></div>
				</div>
				<div class="table-responsive" id="div_batting_all">
					<table class="table table-striped table-condensed" id="table_batting_all" data-toggle="table" data-sort-name="AVG" data-sort-order="desc">
						<thead>
							<tr>
								<th class= "colName" data-field="Name" data-sortable="true" data-sorter="NameSorter" data-align="center">Name<br/>姓名</th>
								<th class= "colG" data-field="G" data-sortable="true" data-sorter="normalSorter" data-align="center">G<br/>場次</th>
								<th class= "colPA" data-field="PA" data-sortable="true" data-sorter="normalSorter" data-align="center">PA<br/>打席</th>
								<th class= "colAB" data-field="AB" data-sortable="true" data-sorter="normalSorter" data-align="center">AB<br/>打數</th>
								<th class= "colH" data-field="H" data-sortable="true" data-sorter="normalSorter" data-align="center">H<br/>安打</th>
								<th class= "colB2" data-field="B2" data-sortable="true" data-sorter="normalSorter" data-align="center">2B<br/>二壘</th>
								<th class= "colB3" data-field="B3" data-sortable="true" data-sorter="normalSorter" data-align="center">3B<br/>三壘</th>
								<th class= "colHR" data-field="HR" data-sortable="true" data-sorter="normalSorter" data-align="center">HR<br/>全壘</th>
								<th class= "colTB" data-field="TB" data-sortable="true" data-sorter="normalSorter" data-align="center">TB<br/>壘打數</th>
								<th class= "colRBI" data-field="RBI" data-sortable="true" data-sorter="normalSorter" data-align="center">RBI<br/>打點</th>
								<th class= "colR" data-field="R" data-sortable="true" data-sorter="normalSorter" data-align="center">R<br/>得分</th>
								<th class= "colSO" data-field="SO" data-sortable="true" data-sorter="normalSorter" data-align="center">SO<br/>三振</th>
								<th class= "colBB" data-field="BB" data-sortable="true" data-sorter="normalSorter" data-align="center">BB<br/>四壞</th>
								<th class= "colIBB" data-field="IBB" data-sortable="true" data-sorter="normalSorter" data-align="center">IBB<br/>故意</th>
								<th class= "colSF" data-field="SF" data-sortable="true" data-sorter="normalSorter" data-align="center">SF<br/>犧牲</th>
								<th class= "colE" data-field="E" data-sortable="true" data-sorter="normalSorter" data-align="center">BOE<br/>失誤</th>
								<th class= "colAVG" data-field="AVG" data-sortable="true" data-sort-name="_AVG_data" data-sorter="AVGSorter" data-align="center">AVG<br/>打擊率</th>
								<th class= "colOBP" data-field="OBP" data-sortable="true" data-sort-name="_OBP_data" data-sorter="OBPSorter" data-align="center">OBP<br/>上壘率</th>
								<th class= "colSLG" data-field="SLG" data-sortable="true" data-sort-name="_SLG_data" data-sorter="SLGSorter" data-align="center">SLG<br/>長打率</th>
								<th class= "colOPS" data-field="OPS" data-sortable="true" data-sort-name="_OPS_data" data-sorter="OPSSorter" data-align="center">OPS<br/>整體攻擊指數</th>
								<th class= "colTA" data-field="TA" data-sortable="true" data-sort-name="_TA_data" data-sorter="TASorter" data-align="center">TA<br/>攻擊指數</th>
							</tr>
						</thead>
						<script>
							$(function(){
								var SortedName = '';
								$('#table_batting_all').on('sort.bs.table', function (e, name, order) {
									SortedName = name;
								});
								$('#table_batting_all').on('post-body.bs.table', function () {
									$('#table_batting_all').find('tbody tr td').each(function(){
										if($(this).hasClass('sorting')){
											$(this).removeClass('sorting');
										}
									});
									SortedItem = $('#table_batting_all').find('tbody tr td.col'+SortedName);
									SortedItem.each(function(){
										$(this).addClass('sorting');
									});
								});
							});
							$(window).on('load resize', function(){
								$('#wrapperForScrollbar').width($('#div_batting_all').width());
								$('#fakeContentForScrollBar').width($('#table_batting_all').width());
							});
							$(function(){
								wrapperForTable = $("#table_batting_all").parent('div')
								$("#wrapperForScrollbar").scroll(function(){
									wrapperForTable.scrollLeft($("#wrapperForScrollbar").scrollLeft());
								});
								wrapperForTable.scroll(function(){
									$("#wrapperForScrollbar").scrollLeft(wrapperForTable.scrollLeft());
								});
							});
							function clearDescription(){
								$('#description').text('');
							}
							function NameSorter(a, b) {
								clearDescription();
								if (a.toLowerCase() > b.toLowerCase()) return 1;
								if (a.toLowerCase() < b.toLowerCase()) return -1;
								return 0;
							}
							function normalSorter(a, b) {
								clearDescription();
								if (parseInt(a) > parseInt(b)) return 1;
								if (parseInt(a) < parseInt(b)) return -1;
								return 0;
							}
							function AVGSorter(a, b) {
								$('#description').text('打擊率 = 安打數 / 打數');
								// 兩階段sorting - 先過濾打席是否足額
								threshold = Math.min((<%= @gameNumberInYear[@year.to_s] * @activePLAYER_rate %>), <%= @activePLAYER %>);
								if(a.pa >= threshold && b.pa < threshold)
									return 1;
								else if(a.pa < threshold && b.pa >= threshold)
									return -1;
								// 再相比實際數值
								else{
									if(a.avg > b.avg) return 1;
									if(a.avg < b.avg) return -1;
									return 0;
								}
							}
							function OBPSorter(a, b) {
								$('#description').text('上壘率 = 安打數 + 四死球 / 打席');
								// 兩階段sorting - 先過濾打席是否足額
								threshold = Math.min((<%= @gameNumberInYear[@year.to_s] * @activePLAYER_rate %>), <%= @activePLAYER %>);
								if(a.pa >= threshold && b.pa < threshold)
									return 1;
								else if(a.pa < threshold && b.pa >= threshold)
									return -1;
								// 再相比實際數值
								else{
									if(a.obp > b.obp) return 1;
									if(a.obp < b.obp) return -1;
									return 0;
								}
							}
							function SLGSorter(a, b) {
								$('#description').text('長打率 = 壘打數 / 打數');
								// 兩階段sorting - 先過濾打席是否足額
								threshold = Math.min((<%= @gameNumberInYear[@year.to_s] * @activePLAYER_rate %>), <%= @activePLAYER %>);
								if(a.pa >= threshold && b.pa < threshold)
									return 1;
								else if(a.pa < threshold && b.pa >= threshold)
									return -1;
								// 再相比實際數值
								else{
									if(a.slg > b.slg) return 1;
									if(a.slg < b.slg) return -1;
									return 0;
								}
							}
							function OPSSorter(a, b) {
								$('#description').text('整體攻擊指數 = 上壘率 + 長打率');
								// 兩階段sorting - 先過濾打席是否足額
								threshold = Math.min((<%= @gameNumberInYear[@year.to_s] * @activePLAYER_rate %>), <%= @activePLAYER %>);
								if(a.pa >= threshold && b.pa < threshold)
									return 1;
								else if(a.pa < threshold && b.pa >= threshold)
									return -1;
								// 再相比實際數值
								else{
									if(a.ops > b.ops) return 1;
									if(a.ops < b.ops) return -1;
									return 0;
								}
							}
							function TASorter(a, b) {
								$('#description').text('攻擊指數 = (壘打數 + 盜壘成功數 + 四死球) / (打數 - 安打數 + 雙殺打)');
								// 兩階段sorting - 先過濾打席是否足額
								threshold = Math.min((<%= @gameNumberInYear[@year.to_s] * @activePLAYER_rate %>), <%= @activePLAYER %>);
								if(a.pa >= threshold && b.pa < threshold)
									return 1;
								else if(a.pa < threshold && b.pa >= threshold)
									return -1;
								// 再相比實際數值
								else{
									if(a.ta > b.ta) return 1;
									if(a.ta < b.ta) return -1;
									return 0;
								}
							}
						</script>
						<% if @allBatting.size != 0 %>
							<tbody>
								<% @allBatting.each do |allBat| %>
									<tr>
										<td class="colName">
											<%= link_to allBat.player_id, controller: "records", action: "batting", player: allBat.player_id, year: @year %>
										</td>
										<td class="colG"><%= allBat.G %></td>
										<td class="colPA"><%= allBat.PA %></td>
										<td class="colAB"><%= allBat.AB %></td>
										<td class="colH"><%= allBat.H %></td>
										<td class="colB2"><%= allBat.B2 %></td>
										<td class="colB3"><%= allBat.B3 %></td>
										<td class="colHR"><%= allBat.HR %></td>
										<td class="colTB"><%= allBat.TB %></td>
										<td class="colRBI"><%= allBat.RBI %></td>
										<td class="colR"><%= allBat.R %></td>
										<td class="colSO"><%= allBat.SO %></td>
										<td class="colBB"><%= allBat.BB %></td>
										<td class="colIBB"><%= allBat.IBB %></td>
										<td class="colSF"><%= allBat.SF %></td>
										<td class="colE"><%= allBat.E %></td>
										<td class="colAVG sorting" data-PA="<%= allBat.PA %>" data-AVG="<%= '%.3f' % allBat.AVG %>"><%= '%.3f' % allBat.AVG %></td>
										<td class="colOBP" data-PA="<%= allBat.PA %>" data-OBP="<%= '%.3f' % allBat.OBP %>"><%= '%.3f' % allBat.OBP %></td>
										<td class="colSLG" data-PA="<%= allBat.PA %>" data-SLG="<%= '%.3f' % allBat.SLG %>"><%= '%.3f' % allBat.SLG %></td>
										<td class="colOPS" data-PA="<%= allBat.PA %>" data-OPS="<%= '%.3f' % allBat.OPS %>"><%= '%.3f' % allBat.OPS %></td>
										<td class="colTA" data-PA="<%= allBat.PA %>" data-TA="<%= '%.3f' % allBat.TA %>"><%= '%.3f' % allBat.TA %></td>
									</tr>
								<% end %>
							</tbody>
						<% end %>
					</table>
				</div>
				<br/>
				<h4><%= @year == "Wildcard"? ("不分"):(@year) %>年度打擊成績總結</h4>
				<br/>
				<div class="table-responsive" id="div_batting_all_summary">
					<table class="table table-striped table-condensed" id="table_batting_all_summary">
						<thead>
							<tr>
								<th>Player<br/>球員</th>
								<th>PA<br/>打席</th>
								<th>AB<br/>打數</th>
								<th>H<br/>安打</th>
								<th>2B<br/>二壘</th>
								<th>3B<br/>三壘</th>
								<th>HR<br/>全壘</th>
								<th>TB<br/>壘打數</th>
								<th>RBI<br/>打點</th>
								<th>R<br/>得分</th>
								<th>SO<br/>三振</th>
								<th>BB<br/>四壞</th>
								<th>IBB<br/>故意</th>
								<th>SF<br/>犧牲</th>
								<th>BOE<br/>失誤</th>
								<th>AVG<br/>打擊率</th>
								<th>OBP<br/>上壘率</th>
								<th>SLG<br/>長打率</th>
								<th>OPS<br/>整體攻擊指數</th>
								<th>TA<br/>攻擊指數</th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<td>Active</td>
								<td><%= @allBattingSummary_M.PA %></td>
								<td><%= @allBattingSummary_M.AB %></td>
								<td><%= @allBattingSummary_M.H %></td>
								<td><%= @allBattingSummary_M.B2 %></td>
								<td><%= @allBattingSummary_M.B3 %></td>
								<td><%= @allBattingSummary_M.HR %></td>
								<td><%= @allBattingSummary_M.TB %></td>
								<td><%= @allBattingSummary_M.RBI %></td>
								<td><%= @allBattingSummary_M.R %></td>
								<td><%= @allBattingSummary_M.SO %></td>
								<td><%= @allBattingSummary_M.BB %></td>
								<td><%= @allBattingSummary_M.IBB %></td>
								<td><%= @allBattingSummary_M.SF %></td>
								<td><%= @allBattingSummary_M.E %></td>
								<td><%= '%.3f' % @allBattingSummary_M.AVG %></td>
								<td><%= '%.3f' % @allBattingSummary_M.OBP %></td>
								<td><%= '%.3f' % @allBattingSummary_M.SLG %></td>
								<td><%= '%.3f' % @allBattingSummary_M.OPS %></td>
								<td><%= '%.3f' % @allBattingSummary_M.TA %></td>
							</tr>
							<tr>
								<td>Non-Active</td>
								<td><%= @allBattingSummary_nM.PA %></td>
								<td><%= @allBattingSummary_nM.AB %></td>
								<td><%= @allBattingSummary_nM.H %></td>
								<td><%= @allBattingSummary_nM.B2 %></td>
								<td><%= @allBattingSummary_nM.B3 %></td>
								<td><%= @allBattingSummary_nM.HR %></td>
								<td><%= @allBattingSummary_nM.TB %></td>
								<td><%= @allBattingSummary_nM.RBI %></td>
								<td><%= @allBattingSummary_nM.R %></td>
								<td><%= @allBattingSummary_nM.SO %></td>
								<td><%= @allBattingSummary_nM.BB %></td>
								<td><%= @allBattingSummary_nM.IBB %></td>
								<td><%= @allBattingSummary_nM.SF %></td>
								<td><%= @allBattingSummary_nM.E %></td>
								<td><%= '%.3f' % @allBattingSummary_nM.AVG %></td>
								<td><%= '%.3f' % @allBattingSummary_nM.OBP %></td>
								<td><%= '%.3f' % @allBattingSummary_nM.SLG %></td>
								<td><%= '%.3f' % @allBattingSummary_nM.OPS %></td>
								<td><%= '%.3f' % @allBattingSummary_nM.TA %></td>
							</tr>
						</tbody>
						<tfoot>
							<tr>
								<td>Total</td>
								<td><%= @allBattingSummary_all.PA %></td>
								<td><%= @allBattingSummary_all.AB %></td>
								<td><%= @allBattingSummary_all.H %></td>
								<td><%= @allBattingSummary_all.B2 %></td>
								<td><%= @allBattingSummary_all.B3 %></td>
								<td><%= @allBattingSummary_all.HR %></td>
								<td><%= @allBattingSummary_all.TB %></td>
								<td><%= @allBattingSummary_all.RBI %></td>
								<td><%= @allBattingSummary_all.R %></td>
								<td><%= @allBattingSummary_all.SO %></td>
								<td><%= @allBattingSummary_all.BB %></td>
								<td><%= @allBattingSummary_all.IBB %></td>
								<td><%= @allBattingSummary_all.SF %></td>
								<td><%= @allBattingSummary_all.E %></td>
								<td><%= '%.3f' % @allBattingSummary_all.AVG %></td>
								<td><%= '%.3f' % @allBattingSummary_all.OBP %></td>
								<td><%= '%.3f' % @allBattingSummary_all.SLG %></td>
								<td><%= '%.3f' % @allBattingSummary_all.OPS %></td>
								<td><%= '%.3f' % @allBattingSummary_all.TA %></td>
							</tr>
						</tfoot>
					</table>
				</div>
			<% end %>
        </div>
        <!--/col-span-9-->
    </div>
</div>
<!-- /Main -->
</section>